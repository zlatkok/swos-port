#include "options.h"
#include "file.h"
#include "controls.h"
#include "render.h"
#include "audio.h"
#include "music.h"
#include "replayOptions.h"
#include "controlOptionsMenu.h"
#include "options.mnu.h"
#include <adlmidi.h>

enum SoundEnabledState { kUnspecified, kOn, kOff, } static m_soundState;
static bool m_noIntro;
static bool m_noReels;
static bool m_noLoadPause;
static int m_bankNo;

static bool m_newScoreboard = false;
static bool m_isCareerCrashFix = false;
static int m_careerCrashFix[4] = { 0, 0, 0, 0 };
static bool m_isGameStyleParam = false;
static int m_gameStyleParam = 0;
static int m_screenMode = 0;
static bool m_isAlphaBlendingMenu = false;
static int m_AlphaBlendingMenu = 60;

using OptionalControls = std::pair<bool, Controls>;
using OptionalJoypadGuid = std::pair<bool, std::string>;

OptionalControls m_pl1Controls;
OptionalControls m_pl2Controls;

OptionalJoypadGuid m_pl1Joypad;
OptionalJoypadGuid m_pl2Joypad;

static int16_t m_gameStyle = 0;         // 0 = PC, 1 = Amiga

static constexpr char kIniFilename[] = "swos.ini";
static constexpr char kStandardSection[] = "standard-options";

void setGameStyleVariables();
void setScreenModeVariables();

extern short patternTableHorz[48];
extern short patternTableVert[32];
extern short patternTableHorz_PCscreen[32];
extern short patternTableVert_PCscreen[32];
extern short patternTableHorz_Amigascreen[32];
extern short patternTableVert_Amigascreen[32];
extern short patternTableHorz_Widescreen[48];
extern short patternTableVert_Widescreen[32];
extern int PatternHorzNum_plus4;
extern int PatternVertNum_plus5;

static const std::array<Option<int16_t>, 9> kStandardOptions = {
    "gameLength",  &g_gameLength, 0, 3, 0,
    "autoReplays",  &g_autoReplays, 0, 1, 0,
    "menuMusic",  &g_menuMusic, 0, 1, 1,
    "autoSaveHighlights",  &g_autoSaveHighlights, 0, 1, 1,
    "allPlayerTeamsEqual", &g_allPlayerTeamsEqual, 0, 1, 0,
    "pitchType", &g_pitchType, -2, 6, 4,
    "chairmanScenes", &g_chairmanScenes, 0, 1, 1,
    "showBigLetterS", &g_spinBigS, 0, 1, 0,
    "gameStyle", &m_gameStyle, 0, 1, 0,
};

void loadOptions()
{
    logInfo("Loading options");

    CSimpleIniA ini(true);
    auto path = pathInRootDir(kIniFilename);

    auto errorCode = ini.LoadFile(path.c_str());
    if (errorCode >= 0) {
        loadOptions(ini, kStandardOptions, kStandardSection);

        loadControlOptions(ini);

        loadAudioOptions(ini);
        loadVideoOptions(ini);
        loadReplayOptions(ini);
    } else {
        logWarn("Error loading options, error code: %d", errorCode);
    }
}

void saveOptions()
{
    logInfo("Saving options...");

    CSimpleIniA ini(true);
    ini.SetValue(kStandardSection, nullptr, nullptr, "; Automatically generated by SWOS\n"
        "; Do not edit! All your changes will be lost\n" );

    saveOptions(ini, kStandardOptions, kStandardSection);
    saveControlOptions(ini);

    saveAudioOptions(ini);
    saveVideoOptions(ini);
    saveReplayOptions(ini);

    auto path = pathInRootDir(kIniFilename);
    auto errorCode = ini.SaveFile(path.c_str());

    if (errorCode < 0) {
        beep();
        logWarn("Failed to save options, error code: %d", errorCode);
    }
}

template<typename LogFunction>
static void parseControls(LogFunction log, OptionalControls& controls, const char *str)
{
    char *endPtr;
    auto controlsIndex = strtol(str, &endPtr, 0);

    if (endPtr == str) {
        controls.first = true;

        if (strstr(str, "none") == str) {
            controls.second = kNone;
        } else if (strstr(str, "keyboard1") == str) {
            controls.second = kKeyboard1;
        } else if (strstr(str, "keyboard2") == str) {
            controls.second = kKeyboard2;
        } else if (strstr(str, "joystick") == str || strstr(str, "joypad")) {
            controls.second = kJoypad;
        } else {
            log(std::string("Unrecognized control name: ") + str);
            controls.first = false;
        }
    } else {
        if (controlsIndex >= 0 && controlsIndex < kNumControls) {
            controls.first = true;
            controls.second = static_cast<Controls>(controlsIndex);
        } else {
            auto max = std::to_string(static_cast<int>(kNumControls) - 1);
            log(std::to_string(controls.second) + " is not valid value for controls ([0.." + max + "] accepted)");
        }
    }
}

std::vector<LogItem> parseCommandLine(int argc, char **argv)
{
    std::vector<LogItem> commandLineWarnings;

    const char kSwosDir[] = "--swos-dir=";
    const char kSound[] = "--sound=";
    const char kNoIntro[] = "--no-intro";
    const char kNoReels[] = "--no-image-reels";
    const char kNoLoadPause[] = "--no-load-pause";
    const char kMaxBank[] = "--max-bank";
    const char kBankNum[] = "--bank-number=";
    const char kPl1Controls[] = "--pl1controls=";
    const char kPl2Controls[] = "--pl2controls=";
    const char kPl1Joypad[] = "--pl1joypad=";
    const char kPl2Joypad[] = "--pl2joypad=";
	
	const char kNewScoreboard[] = "--new-scoreboard";
	const char kCareerCrashFix[] =  "--career-crash-fix=";
	const char kGameStyle[] = "--game-style=";
	const char kScreenMode[] = "--screen-mode=";
	const char kAlphaBlendingMenu[] = "--alpha-blending-menu=";

    auto log = [&commandLineWarnings](const std::string& str, LogCategory category = kWarning) {
        commandLineWarnings.emplace_back(category, str);
    };

    for (int i = 1; i < argc; i++) {
        if (strstr(argv[i], kSwosDir) == argv[i]) {
            setRootDir(argv[i] + sizeof(kSwosDir) - 1);
        } else if (strstr(argv[i], kSound) == argv[i]) {
            auto setting = argv[i] + sizeof(kSound) - 1;
            m_soundState = (tolower(setting[0]) != 'o' || tolower(setting[1]) != 'n') && setting[0] != '1' ? kOff : kOn;
        } else if (!strcmp(argv[i], kNoIntro)) {
            m_noIntro = true;
        } else if (!strcmp(argv[i], kNoReels)) {
            m_noReels = true;
        } else if (!strcmp(argv[i], kNoLoadPause)) {
            m_noLoadPause = true;
        } else if (!strcmp(argv[i], kMaxBank)) {
            log(std::string("Maximum bank number is ") + std::to_string(adl_getBanksCount() - 1), kInfo);
        } else if (strstr(argv[i], kBankNum) == argv[i]) {
            auto bankNumStr = argv[i] + sizeof(kBankNum) - 1;
            auto bankNo = atoi(bankNumStr);
            auto maxBankNo = adl_getBanksCount() - 1;
            if (bankNo >= 0 && bankNo <= maxBankNo) {
                m_bankNo = bankNo;
            } else {
                auto warningText = std::string("Invalid bank number ") + std::to_string(bankNo) +
                    ", range is [0.." + std::to_string(maxBankNo) + "]";
                log(warningText);
            }
        } else if (strstr(argv[i], kPl1Controls) == argv[i] || strstr(argv[i], kPl2Controls)) {
            assert(argv[i][4] == '1' || argv[i][4] == '2');

            auto& controls = argv[i][4] == '1' ? m_pl1Controls : m_pl2Controls;
            auto controlsStr = argv[i] + sizeof(kPl1Controls) - 1;

            parseControls(log, controls, controlsStr);

            if (controls.first && controls.second == kNone && &controls == &m_pl1Controls) {
                controls.first = false;
                log("Player 1 can not have controls disabled");
            }
        } else if (strstr(argv[i], kPl1Joypad) == argv[i] || strstr(argv[i], kPl2Joypad) == argv[i]) {
            assert(argv[i][4] == '1' || argv[i][4] == '2');

            auto& joypad = argv[i][4] == '1' ? m_pl1Joypad : m_pl2Joypad;
            auto joypadStr = argv[i] + sizeof(kPl1Joypad) - 1;

            if (*joypadStr) {
                joypad.first = true;
                joypad.second = joypadStr;
            }
		}

		else if (!strcmp(argv[i], kNewScoreboard)) {
			m_newScoreboard = true;
			if (m_newScoreboard == true) {
				dseg_168941 = 3;
			}
			else {
				dseg_168941 = 4;
			}
		}
		else if (strstr(argv[i], kCareerCrashFix) == argv[i]) {
			m_isCareerCrashFix = true;
			for (int j = 0; j <= 3; j++) {
				m_careerCrashFix[j] = 0;
			}
			for (int j = 0; j <= 3; j++) {
				if (argv[i][19 + j] == '1') {
					m_careerCrashFix[j] = 1;
				}
			}
		}
		else if (strstr(argv[i], kGameStyle) == argv[i]) {
			m_isGameStyleParam = true;
			m_gameStyleParam = 0;
			if (argv[i][13] == '1') m_gameStyleParam = 1;
			m_gameStyle = m_gameStyleParam;
		}
		else if (strstr(argv[i], kScreenMode) == argv[i]) {
			m_screenMode = 0;
			if (argv[i][14] == '1') m_screenMode = 1;
			if (argv[i][14] == '2') m_screenMode = 2;
		}
		else if (strstr(argv[i], kAlphaBlendingMenu) == argv[i]) {
			m_isAlphaBlendingMenu = true;
			char ratio[32] = { 0, };
			int len = strlen(argv[i]);
			for (int j = 0; j <= len - 23; j++) {
				ratio[j] = argv[i][22 + j];
			}
			m_AlphaBlendingMenu = atoi(ratio);
        } else {
            log(std::string("Unknown option ignored: ") + argv[i]);
        }
    }
	setGameStyleVariables();
	setScreenModeVariables();	

    return commandLineWarnings;
}

void normalizeOptions()
{
    if (m_soundState != kUnspecified) {
        auto soundOff = m_soundState == kOff;
        g_soundOff = soundOff;
        g_musicOff = soundOff;
        g_menuMusic = !g_musicOff;
    }

    normalizeInput();
}

bool disableIntro()
{
    return m_noIntro;
}

bool disableImageReels()
{
    return m_noReels;
}

bool doNotPauseLoadingScreen()
{
    return m_noLoadPause;
}

int midiBankNumber()
{
    return m_bankNo;
}

bool isNewScoreboard()
{
	return m_newScoreboard;
}

bool isCareerCrashFix()
{
	return m_isCareerCrashFix;
}

int getCareerCrashFix(int i)
{
	return m_careerCrashFix[i];
}

bool isGameStyleParam()
{
	return m_isGameStyleParam;
}

int getGameStyleParam()
{
	return m_gameStyleParam;
}

void setGameStyle(int gs)
{
	m_gameStyle = m_gameStyleParam;
}

int getGameStyle()
{
	return m_gameStyle;
}

int getScreenMode()
{
	return m_screenMode;
}

bool isAlphaBlendingMenu()
{
	return m_isAlphaBlendingMenu;
}

int getAlphaBlendingMenu()
{
	return m_AlphaBlendingMenu;
}

//
// options menu
//

void SWOS::OptionsMenuSelected()
{
    logInfo("Showing options menu...");

    showMenu(optionsMenu);

    logInfo("Leaving options menu");
    CommonMenuExit();
}

static void exitOptions()
{
    if (controlsStatus == 0x20) {
        SetExitMenuFlag();
        saveOptions();
    } else if (controlsStatus == 0x30 && ++showPrereleaseCounter == 15) {
        auto entry = getMenuEntry(OptionsMenu::Entries::secret);
        entry->show();
    }
}

static void doShowVideoOptionsMenu()
{
    showVideoOptionsMenu();
}

static void doShowAudioOptionsMenu()
{
    showAudioOptionsMenu();
}

static void doShowControlOptionsMenu()
{
    showControlOptionsMenu();
}

static void showGameplayOptions()
{
    showMenu(gameplayOptionsMenu);
}

static void changeGameStyle()
{
    m_gameStyle = !m_gameStyle;
	logInfo("Game style changed to %s", m_gameStyle ? "AMIGA" : "PC");

	setGameStyleVariables();
}

static void initGamePlayOptions()
{
    auto autoSaveReplaysEntry = getMenuEntry(GameplayOptionsMenu::autoSaveReplays);
    strcpy(autoSaveReplaysEntry->string(), getAutoSaveReplays() ? aOn : aOff);
}

static void toggleAutoSaveReplays()
{
    setAutoSaveReplays(!getAutoSaveReplays());
    initGamePlayOptions();
}

void setGameStyleVariables()
{
	if (m_gameStyle == 0) {
		keeperSaveDistance = 16;
		ballGroundConstant = 13;
		ballAirConstant = 4;
		// -3, 4, 1, 0, 0, -1, -1
		pitchBallSpeedInfluence[0] = -3; 
		pitchBallSpeedInfluence[1] =  4; 
		pitchBallSpeedInfluence[2] =  1; 
		pitchBallSpeedInfluence[3] =  0; 
		pitchBallSpeedInfluence[4] =  0; 
		pitchBallSpeedInfluence[5] = -1; 
		pitchBallSpeedInfluence[6] = -1;
		gravityConstant = 3291;
	}
	else {
		keeperSaveDistance = 24;
		ballGroundConstant = 16;
		ballAirConstant = 10;
		// -2, 2, 3, 0, 0, -1, -1
		pitchBallSpeedInfluence[0] = -2; 
		pitchBallSpeedInfluence[1] =  2; 
		pitchBallSpeedInfluence[2] =  3; 
		pitchBallSpeedInfluence[3] =  0; 
		pitchBallSpeedInfluence[4] =  0; 
		pitchBallSpeedInfluence[5] = -1; 
		pitchBallSpeedInfluence[6] = -1;
		gravityConstant = 4608;		
	}
	
	if (keeperSaveDistance == 16) {		
	//if (keeperSaveDistance == 24) {
		GS_27_22 = 27;
		GS_54_49 = 54;
		GS_55_50 = 55;

		GS_110_100 = 110;
		GS_385_350 = 385;
		GS_550_500 = 550;
		GS_660_600 = 660;
		GS_825_750 = 825;
	}
	else {
		GS_27_22 = 22;
		GS_54_49 = 49;
		GS_55_50 = 50;

		GS_110_100 = 100;
		GS_385_350 = 350;
		GS_550_500 = 500;
		GS_660_600 = 600;
		GS_825_750 = 750;
	}	
}

void setScreenModeVariables()
{
	int i;

	if (m_screenMode == 0) {
		// Original PC Screen
		kVgaWidth = 320;
		kVgaHeight = 200;
		kGameScreenWidth = 384;
		
		PatternHorzNum_plus4 = 24;
		PatternVertNum_plus5 = 18;
		
		for (i = 0; i <= 31; i++) {
			patternTableHorz[i] = patternTableHorz_PCscreen[i];
		}
		for (i = 0; i <= 31; i++) {
			patternTableVert[i] = patternTableVert_PCscreen[i];
		}
		DrawPatternVerticalCount = 2;
		animPatternsRandomTable[63] = 0;

		SM_0_0_64    = 0;
		SM_0_26_26   = 0;
		SM_4_3_3     = 4;
		SM_8_10_10   = 8;
		SM_10_36_36  = 10;
		SM_12_20_20  = 12;
		SM_16_16_88  = 16;
		SM_18_22_22  = 18;
		SM_19_35_35  = 19;
		SM_20_22_31  = 20;
		SM_23_39_39  = 23;
		SM_24_25_34  = 24;
		SM_39_55_55  = 39;
		SM_40_44_62  = 40;
		SM_60_66_93  = 60;
		SM_63_66_93  = 63;		
		SM_64_67_94  = 64;
		SM_80_80_152 = 80;

        SM_100_136_136 = 100;
		SM_128_136_208 = 128;
		SM_143_151_223 = 143;
		SM_150_158_230 = 150;
		SM_152_160_240 = 152;
		SM_157_165_237 = 157;
		SM_160_168_240 = 160;
		SM_160_176_176 = 160;
		SM_163_171_243 = 163;
		SM_165_173_245 = 165;
		SM_176_168_96  = 176;
		SM_179_261_261 = 179;
		SM_192_200_272 = 192;
		SM_200_272_272 = 200;
		SM_211_211_291 = 211;
		SM_240_256_328 = 240;
		SM_241_305_305 = 241;
		SM_246_310_310 = 246;
		SM_248_264_408 = 248;
		SM_249_313_313 = 249;
		SM_263_327_327 = 263;
		SM_285_301_445 = 285;
		SM_288_304_304 = 288;
		SM_310_326_470 = 310;
		SM_320_320_320 = 320;
		SM_320_336_480 = 320;
		SM_336_256_256 = 336;		
		SM_336_336_416 = 336;
		SM_339_303_303 = 339;
		SM_359_323_323 = 359;
		SM_352_336_192 = 352;
		SM_368_384_528 = 368;
		SM_384_400_544 = 384;
		SM_590_590_670 = 590;
		SM_616_544_544 = 616;
		SM_664_592_592 = 664;
		SM_680_608_608 = 680;

		SM_1040_1144_1612 = 1040;
		SM_6144_6400_8704 = 6144;
	}
	else if (m_screenMode == 1) {
		// Original Amiga Screen
		kVgaWidth = 336;
		kVgaHeight = 272;
		kGameScreenWidth = 400;
		
		PatternHorzNum_plus4 = 25;
		PatternVertNum_plus5 = 22;

		for (i = 0; i <= 31; i++) {
			patternTableHorz[i] = patternTableHorz_Amigascreen[i];
		}
		for (i = 0; i <= 31; i++) {
			patternTableVert[i] = patternTableVert_Amigascreen[i];
		}
		DrawPatternVerticalCount = 2;
		animPatternsRandomTable[66] = 0;

		SM_0_0_64   = 0;
		SM_0_26_26  = 26;
		SM_4_3_3    = 3;
		SM_8_10_10  = 10;
		SM_10_36_36 = 36;
		SM_12_20_20 = 20;
		SM_16_16_88 = 16;
		SM_18_22_22 = 22;
		SM_19_35_35 = 35;
		SM_20_22_31 = 22;		
		SM_23_39_39 = 39;
		SM_24_25_34 = 25;
		SM_39_55_55 = 55;
		SM_40_44_62 = 44;
		SM_60_66_93 = 66;
		SM_63_66_93 = 66;		
		SM_64_67_94 = 67;
		SM_80_80_152 = 80;

        SM_100_136_136 = 136;
		SM_128_136_208 = 136;
		SM_143_151_223 = 151;
		SM_150_158_230 = 158;
		SM_152_160_240 = 160;
		SM_157_165_237 = 165;
		SM_160_168_240 = 168;
		SM_160_176_176 = 176;
		SM_163_171_243 = 171;
		SM_165_173_245 = 173;
		SM_176_168_96  = 168;
		SM_179_261_261 = 261;
		SM_192_200_272 = 200;
		SM_200_272_272 = 272;
		SM_211_211_291 = 211;
		SM_240_256_328 = 256;
		SM_241_305_305 = 305;
		SM_246_310_310 = 310;
		SM_248_264_408 = 264;
		SM_249_313_313 = 313;
		SM_263_327_327 = 327;
		SM_285_301_445 = 301;
		SM_288_304_304 = 304;
		SM_310_326_470 = 326;
		SM_320_320_320 = 320;
		SM_320_336_480 = 336;
		SM_336_256_256 = 256;		
		SM_336_336_416 = 336;
		SM_339_303_303 = 303;
		SM_359_323_323 = 323;
		SM_352_336_192 = 336;
		SM_368_384_528 = 384;
		SM_384_400_544 = 400;
		SM_590_590_670 = 590;
		SM_616_544_544 = 544;
		SM_664_592_592 = 592;
		SM_680_608_608 = 608;

		SM_1040_1144_1612 = 1144;
		SM_6144_6400_8704 = 6400;
	}
	else if (m_screenMode == 2) {
		// Widecreen
		kVgaWidth = 480;
		kVgaHeight = 272;
		kGameScreenWidth = 544;
		
		PatternHorzNum_plus4 = 34;
		PatternVertNum_plus5 = 22;

		for (i = 0; i <= 47; i++) {
			patternTableHorz[i] = patternTableHorz_Widescreen[i];
		}
		for (i = 0; i <= 31; i++) {
			patternTableVert[i] = patternTableVert_Widescreen[i];
		}
		DrawPatternVerticalCount = 3;
		animPatternsRandomTable[93] = 0;

		SM_0_0_64   = 64;
		SM_0_26_26  = 26;
		SM_4_3_3    = 3;
		SM_8_10_10  = 10;
		SM_10_36_36 = 36;
		SM_12_20_20 = 20;
		SM_16_16_88 = 88;
		SM_18_22_22 = 22;
		SM_19_35_35 = 35;
		SM_20_22_31 = 31;		
		SM_23_39_39 = 39;
		SM_24_25_34 = 34;
		SM_39_55_55 = 55;
		SM_40_44_62 = 62;
		SM_60_66_93 = 93;
		SM_63_66_93 = 93;		
		SM_64_67_94 = 94;
		SM_80_80_152 = 152;

        SM_100_136_136 = 136;
		SM_128_136_208 = 208;
		SM_143_151_223 = 223;
		SM_150_158_230 = 230;
		SM_152_160_240 = 240;
		SM_157_165_237 = 237;
		SM_160_168_240 = 240;
		SM_160_176_176 = 176;
		SM_163_171_243 = 243;
		SM_165_173_245 = 245;
		SM_176_168_96  = 96;
		SM_179_261_261 = 261;
		SM_192_200_272 = 272;
		SM_200_272_272 = 272;
		SM_211_211_291 = 291;
		SM_240_256_328 = 328;
		SM_241_305_305 = 305;
		SM_246_310_310 = 310;
		SM_248_264_408 = 408;
		SM_249_313_313 = 313;
		SM_263_327_327 = 327;
		SM_285_301_445 = 445;
		SM_288_304_304 = 304;
		SM_310_326_470 = 470;
		SM_320_320_320 = 320;
		SM_320_336_480 = 480;
		SM_336_256_256 = 256;		
		SM_336_336_416 = 416;
		SM_339_303_303 = 303;
		SM_359_323_323 = 323;
		SM_352_336_192 = 192;
		SM_368_384_528 = 528;
		SM_384_400_544 = 544;
		SM_590_590_670 = 670;
		SM_616_544_544 = 544;
		SM_664_592_592 = 592;
		SM_680_608_608 = 608;

		SM_1040_1144_1612 = 1612;
		SM_6144_6400_8704 = 8704;
	}
	
	kVgaScreenSize = kVgaWidth * kVgaHeight;
	
	kVgaWidthAdder      = kVgaWidth - kMenuScreenWidth;
	kVgaHeightAdder     = kVgaHeight - kMenuScreenHeight;
	kVgaWidthAdderHalf  = kVgaWidthAdder  / 2;
	kVgaHeightAdderHalf = kVgaHeightAdder / 2;
	
	kWindowWidth = 4 * kVgaWidth;
	kWindowHeight = 4 * kVgaHeight;	
}
